generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ======================================================
 * ENUMS
 * ======================================================
 */

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

/**
 * High-level CRM status (REAL lead state)
 */
enum LeadStatus {
  FRESH
  ASSIGNED
  IN_PROGRESS
  FOLLOW_UP
  WON
  LOST
}

/**
 * Activity type
 */
enum LeadActivityType {
  CALL
  STATUS_CHANGE
  REMARK
  ASSIGNED
}

/**
 * System call outcomes (unchangeable)
 */
enum CallOutcome {
  NOT_PICKED_UP
  BUSY
  SWITCHED_OFF
  CALL_LATER
  CALL_BACK_SCHEDULED
  INTERESTED
  NOT_INTERESTED
  WRONG_NUMBER
}

/**
 * ======================================================
 * USER / TEAM
 * ======================================================
 */

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String
  role     Role

  isActive Boolean @default(true)

  failedLoginCount Int       @default(0)
  lockUntil        DateTime?

  teamId String?
  team   Team?   @relation("TeamMembers", fields: [teamId], references: [id])

  managedTeam Team? @relation("TeamManager")

  assignedLeads  Lead[]         @relation("UserAssignedLeads")
  leadActivities LeadActivity[] @relation("UserLeadActivities")

  attendance Attendance[]

  auditLogs     AuditLog[]
  forms         Form[]
  formResponses FormResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Team {
  id   String @id @default(uuid())
  name String

  managerId String @unique
  manager   User   @relation("TeamManager", fields: [managerId], references: [id])

  users User[] @relation("TeamMembers")
  leads Lead[]

  /**
   * ðŸ”¥ Pipeline configuration
   */
  callOutcomeConfigs CallOutcomeConfig[]

  forms Form[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ======================================================
 * ATTENDANCE
 * ======================================================
 */

model Attendance {
  id       String    @id @default(uuid())
  userId   String
  date     DateTime
  clockIn  DateTime
  clockOut DateTime?

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, date])
}

/**
 * ======================================================
 * PIPELINE CONFIG (MANAGER-ONLY, DOES NOT CHANGE LEAD STATUS)
 * ======================================================
 */

/**
 * This represents stages like:
 * NOT_PICKED_UP, BUSY, INTERESTED, etc
 */
model CallOutcomeConfig {
  id     String @id @default(uuid())
  teamId String

  /**
   * e.g. NOT_PICKED_UP, INTERESTED, WON, LOST
   */
  name String

  /**
   * Which stage this belongs to
   */
  stage PipelineStage

  isSystem Boolean             @default(false)
  reasons  CallOutcomeReason[]

  team Team @relation(fields: [teamId], references: [id])

  createdAt      DateTime       @default(now())
  leadActivities LeadActivity[]

  @@unique([teamId, name])
}

enum PipelineStage {
  ACTIVE
  CLOSED
}

/**
 * Reasons INSIDE an outcome
 * Example:
 * Outcome = NOT_INTERESTED
 * Reasons = ["Too expensive", "Not required"]
 */
model CallOutcomeReason {
  id        String   @id @default(uuid())
  outcomeId String
  label     String
  createdAt DateTime @default(now())

  outcome        CallOutcomeConfig @relation(fields: [outcomeId], references: [id])
  leadActivities LeadActivity[]
}

/**
 * ======================================================
 * LEAD
 * ======================================================
 */

model Lead {
  id String @id @default(uuid())

  companyName String
  personName  String
  phone       String

  status LeadStatus @default(FRESH)

  followUpAt DateTime?

  assignedToId String?
  assignedTo   User?   @relation("UserAssignedLeads", fields: [assignedToId], references: [id])

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  meta Json?

  activities    LeadActivity[]
  formResponses FormResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([assignedToId])
  @@index([status])
  @@index([phone])
}

/**
 * ======================================================
 * LEAD ACTIVITY (CALL LOGGING)
 * ======================================================
 */

model LeadActivity {
  id String @id @default(uuid())

  leadId String
  userId String

  type LeadActivityType

  oldStatus LeadStatus?
  newStatus LeadStatus?

  // âœ… REPLACED enum
  outcomeId String?
  outcome   CallOutcomeConfig? @relation(fields: [outcomeId], references: [id])

  outcomeReasonId String?
  outcomeReason   CallOutcomeReason? @relation(fields: [outcomeReasonId], references: [id])

  remark String?

  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id])
  user User @relation("UserLeadActivities", fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([outcomeId])
}

/**
 * ======================================================
 * AUDIT / FORMS / SETTINGS / INTEGRATIONS
 * ======================================================
 */

model AuditLog {
  id String @id @default(uuid())

  action   String
  entity   String
  entityId String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  meta Json?

  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([userId])
}

model Form {
  id String @id @default(uuid())

  name        String
  description String?

  teamId String
  team   Team   @relation(fields: [teamId], references: [id])

  schema Json

  isActive Boolean @default(true)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  responses FormResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FormResponse {
  id String @id @default(uuid())

  formId String
  leadId String
  userId String

  schemaSnapshot Json
  values         Json

  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  lead      Lead     @relation(fields: [leadId], references: [id])
  form      Form     @relation(fields: [formId], references: [id])

  @@unique([formId, leadId, userId])
}

model Setting {
  id String @id @default(uuid())

  scope  SettingScope
  teamId String?

  key   String
  value Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scope, teamId, key])
}

enum SettingScope {
  SYSTEM
  TEAM
}

model Integration {
  id String @id @default(uuid())

  provider IntegrationProvider
  teamId   String
  isActive Boolean             @default(true)

  config Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, teamId])
}

enum IntegrationProvider {
  JUSTDIAL
  INDIAMART
}
